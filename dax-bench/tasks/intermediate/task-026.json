{
  "id": "task-026",
  "version": "1.0",
  "title": "Safe Ratio with Cascading Fallbacks",
  "description": "Handle division errors with multiple fallback values using DIVIDE and conditional logic.",
  "complexity": "intermediate",
  "category": "calculation",
  "prompt": {
    "system": "You are a DAX expert. Generate only the DAX code without any explanation or markdown formatting. Return the measure definition starting with the name followed by an equals sign.",
    "user": "Create a measure called 'Profit Margin %' that calculates (Net Price - Unit Cost) / Net Price * 100. Handle these cases: (1) If Net Price is zero or BLANK, return 0. (2) If the calculation results in a negative margin, return 0. The result should be a percentage value (e.g., 25 for 25%).",
    "dataModelContext": "You are working with a sales database. Sales contains: Net Price (decimal), Unit Cost (decimal). Some products may have zero or missing Net Price values."
  },
  "expectedOutput": {
    "dax": "Profit Margin % = VAR TotalRevenue = SUM(Sales[Net Price]) VAR TotalCost = SUM(Sales[Unit Cost]) VAR RawMargin = DIVIDE(TotalRevenue - TotalCost, TotalRevenue, 0) * 100 RETURN IF(RawMargin < 0, 0, RawMargin)",
    "alternativeCorrect": [
      "Profit Margin % = MAX(0, DIVIDE(SUM(Sales[Net Price]) - SUM(Sales[Unit Cost]), SUM(Sales[Net Price]), 0) * 100)",
      "Profit Margin % = VAR Margin = DIVIDE(SUM(Sales[Net Price]) - SUM(Sales[Unit Cost]), SUM(Sales[Net Price])) * 100 RETURN IF(ISBLANK(Margin) || Margin < 0, 0, Margin)",
      "Profit Margin % = IF(SUM(Sales[Net Price]) <= 0, 0, MAX(0, (SUM(Sales[Net Price]) - SUM(Sales[Unit Cost])) / SUM(Sales[Net Price]) * 100))",
      "Profit Margin % = VAR Net = SUM(Sales[Net Price]) VAR Cost = SUM(Sales[Unit Cost]) VAR Margin = DIVIDE(Net - Cost, Net, 0) * 100 RETURN IF(Margin > 0, Margin, 0)"
    ],
    "expectedResult": {
      "columns": ["Category", "Profit Margin %"],
      "rows": [
        {"Category": "Audio", "Profit Margin %": 35.5},
        {"Category": "Loss Leader", "Profit Margin %": 0}
      ]
    }
  },
  "evaluationCriteria": {
    "syntaxWeight": 0.3,
    "outputMatchWeight": 0.7,
    "requiredElements": ["DIVIDE"],
    "partialCreditRules": [
      { "condition": "contains_DIVIDE", "credit": 0.4 },
      { "condition": "contains_IF", "credit": 0.2 },
      { "condition": "handles_negative", "credit": 0.2 }
    ],
    "bestPractices": {
      "required": ["DIVIDE"],
      "preferred": ["VAR", "RETURN"],
      "antiPatterns": ["division_by_zero_unhandled"]
    },
    "dimensionWeights": {
      "correctness": 0.40,
      "bestPractices": 0.25,
      "performance": 0.20,
      "clarity": 0.15
    },
    "performanceNotes": "DIVIDE with third parameter handles division by zero efficiently"
  },
  "hints": [
    "DIVIDE's third parameter is the alternate result when denominator is zero",
    "Use MAX(0, value) or IF to handle negative results",
    "VAR pattern avoids recalculating sums multiple times"
  ],
  "tags": ["measure", "divide", "error-handling", "margin", "contoso"]
}
