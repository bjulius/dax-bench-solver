{
  "id": "task-015",
  "version": "1.0",
  "title": "Product Percentage of Category Total",
  "description": "Calculate each product's contribution to its category total, testing row-to-filter context transition.",
  "complexity": "intermediate",
  "category": "context-transition",
  "prompt": {
    "system": "You are a DAX expert. Generate only the DAX code without any explanation or markdown formatting. Return the column expression as a calculated column definition.",
    "user": "Create a calculated column in the Product table called 'Category Share %' that shows what percentage each product's total sales represents of its category's total sales. For example, if a product sold $100 and its category sold $1000, the value should be 10 (representing 10%).",
    "dataModelContext": "You are working with a sales database. Product contains: ProductKey, Product Name, Category. Sales contains: Net Price (decimal), ProductKey. The relationship is Product[ProductKey] 1â†’M Sales[ProductKey]."
  },
  "expectedOutput": {
    "dax": "Category Share % = VAR ProductSales = CALCULATE(SUM(Sales[Net Price])) VAR CategorySales = CALCULATE(SUM(Sales[Net Price]), ALLEXCEPT(Product, Product[Category])) RETURN DIVIDE(ProductSales, CategorySales) * 100",
    "alternativeCorrect": [
      "Category Share % = DIVIDE(CALCULATE(SUM(Sales[Net Price])), CALCULATE(SUM(Sales[Net Price]), ALLEXCEPT(Product, Product[Category]))) * 100",
      "Category Share % = VAR ProductSales = CALCULATE(SUM(Sales[Net Price])) VAR CategorySales = CALCULATE(SUM(Sales[Net Price]), ALL(Product), VALUES(Product[Category])) RETURN DIVIDE(ProductSales, CategorySales) * 100",
      "Category Share % = DIVIDE(CALCULATE(SUM(Sales[Net Price])), CALCULATE(SUM(Sales[Net Price]), ALL(Product), Product[Category] = EARLIER(Product[Category]))) * 100"
    ],
    "expectedResult": {
      "columns": ["Product Name", "Category Share %"],
      "rows": [
        {"Product Name": "Contoso 512MB MP3 Player E51 Blue", "Category Share %": 2.34}
      ]
    }
  },
  "evaluationCriteria": {
    "syntaxWeight": 0.3,
    "outputMatchWeight": 0.7,
    "requiredElements": ["CALCULATE", "ALLEXCEPT"],
    "partialCreditRules": [
      { "condition": "contains_CALCULATE", "credit": 0.3 },
      { "condition": "contains_ALLEXCEPT", "credit": 0.3 },
      { "condition": "contains_DIVIDE", "credit": 0.2 }
    ],
    "bestPractices": {
      "required": ["DIVIDE"],
      "preferred": ["VAR", "RETURN"],
      "antiPatterns": ["division_by_zero_unhandled"]
    },
    "dimensionWeights": {
      "correctness": 0.40,
      "bestPractices": 0.25,
      "performance": 0.20,
      "clarity": 0.15
    },
    "performanceNotes": "ALLEXCEPT is more efficient than ALL + VALUES for keeping specific columns"
  },
  "hints": [
    "In a calculated column, CALCULATE triggers context transition from row to filter context",
    "ALLEXCEPT keeps filters on specified columns while removing others",
    "Use DIVIDE for safe division"
  ],
  "tags": ["calculated-column", "context-transition", "allexcept", "percentage", "contoso"]
}
