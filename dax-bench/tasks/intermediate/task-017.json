{
  "id": "task-017",
  "version": "1.0",
  "title": "Granularity-Aware Measure with VALUES",
  "description": "Create a measure that behaves differently based on the granularity of the current context using VALUES and HASONEVALUE.",
  "complexity": "intermediate",
  "category": "context-transition",
  "prompt": {
    "system": "You are a DAX expert. Generate only the DAX code without any explanation or markdown formatting. Return the measure definition starting with the name followed by an equals sign.",
    "user": "Create a measure called 'Smart Sales' that returns the total Net Price when viewing data at the Year level, but returns the average Net Price per month when viewing data at the Month level. Use HASONEVALUE to detect the granularity.",
    "dataModelContext": "You are working with a sales database. Sales contains: Net Price (decimal). Date contains: Year (integer), Month (integer - 1 to 12). Sales[Order Date] relates to Date[Date]."
  },
  "expectedOutput": {
    "dax": "Smart Sales = IF(HASONEVALUE('Date'[Year]) && NOT(HASONEVALUE('Date'[Month])), SUM(Sales[Net Price]), IF(HASONEVALUE('Date'[Month]), AVERAGEX(VALUES('Date'[Month]), CALCULATE(SUM(Sales[Net Price]))), SUM(Sales[Net Price])))",
    "alternativeCorrect": [
      "Smart Sales = VAR IsYearLevel = HASONEVALUE('Date'[Year]) && COUNTROWS(VALUES('Date'[Month])) > 1 VAR IsMonthLevel = HASONEVALUE('Date'[Month]) RETURN IF(IsYearLevel, SUM(Sales[Net Price]), IF(IsMonthLevel, SUM(Sales[Net Price]), DIVIDE(SUM(Sales[Net Price]), COUNTROWS(VALUES('Date'[Month])))))",
      "Smart Sales = SWITCH(TRUE(), HASONEVALUE('Date'[Month]), SUM(Sales[Net Price]), HASONEVALUE('Date'[Year]), DIVIDE(SUM(Sales[Net Price]), DISTINCTCOUNT('Date'[Month])), SUM(Sales[Net Price]))"
    ],
    "expectedResult": {
      "columns": ["Year", "Smart Sales"],
      "rows": [
        {"Year": 2020, "Smart Sales": 12345678.90}
      ]
    }
  },
  "evaluationCriteria": {
    "syntaxWeight": 0.3,
    "outputMatchWeight": 0.7,
    "requiredElements": ["HASONEVALUE", "VALUES"],
    "partialCreditRules": [
      { "condition": "contains_HASONEVALUE", "credit": 0.4 },
      { "condition": "contains_VALUES", "credit": 0.2 },
      { "condition": "contains_IF", "credit": 0.2 }
    ],
    "bestPractices": {
      "required": [],
      "preferred": ["SWITCH", "VAR", "RETURN"],
      "antiPatterns": []
    },
    "performanceNotes": "HASONEVALUE is efficient for checking single-value filter context"
  },
  "hints": [
    "HASONEVALUE returns TRUE when exactly one value is in filter context",
    "VALUES returns a table of distinct values in current filter context",
    "Consider using SWITCH(TRUE(), ...) for multiple conditions"
  ],
  "tags": ["measure", "hasonevalue", "values", "context-transition", "conditional", "contoso"]
}
