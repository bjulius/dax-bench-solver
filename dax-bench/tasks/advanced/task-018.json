{
  "id": "task-018",
  "version": "1.0",
  "title": "Running Count with EARLIER",
  "description": "Calculate a running count using EARLIER to reference outer row context in nested iteration.",
  "complexity": "advanced",
  "category": "context-transition",
  "prompt": {
    "system": "You are a DAX expert. Generate only the DAX code without any explanation or markdown formatting. Return the column expression as a calculated column definition.",
    "user": "Create a calculated column in the Product table called 'Category Rank by Price' that ranks each product within its category by Unit Price (highest price = rank 1). Products with the same Unit Price should have the same rank.",
    "dataModelContext": "You are working with a sales database. Product contains: ProductKey (integer), Product Name (text), Category (text), Unit Price (decimal)."
  },
  "expectedOutput": {
    "dax": "Category Rank by Price = COUNTROWS(FILTER(Product, Product[Category] = EARLIER(Product[Category]) && Product[Unit Price] > EARLIER(Product[Unit Price]))) + 1",
    "alternativeCorrect": [
      "Category Rank by Price = VAR CurrentCategory = Product[Category] VAR CurrentPrice = Product[Unit Price] RETURN COUNTROWS(FILTER(Product, Product[Category] = CurrentCategory && Product[Unit Price] > CurrentPrice)) + 1",
      "Category Rank by Price = RANKX(FILTER(ALL(Product), Product[Category] = EARLIER(Product[Category])), Product[Unit Price], , DESC, DENSE)"
    ],
    "expectedResult": {
      "columns": ["Product Name", "Category", "Unit Price", "Category Rank by Price"],
      "rows": [
        {"Product Name": "Premium Headphones", "Category": "Audio", "Unit Price": 299.99, "Category Rank by Price": 1},
        {"Product Name": "Budget Earbuds", "Category": "Audio", "Unit Price": 29.99, "Category Rank by Price": 5}
      ]
    }
  },
  "evaluationCriteria": {
    "syntaxWeight": 0.3,
    "outputMatchWeight": 0.7,
    "requiredElements": ["EARLIER", "FILTER"],
    "partialCreditRules": [
      { "condition": "contains_EARLIER", "credit": 0.3 },
      { "condition": "contains_FILTER", "credit": 0.2 },
      { "condition": "contains_COUNTROWS", "credit": 0.2 },
      { "condition": "references_column_Category", "credit": 0.15 }
    ],
    "bestPractices": {
      "required": [],
      "preferred": ["VAR", "RANKX"],
      "antiPatterns": []
    },
    "dimensionWeights": {
      "correctness": 0.45,
      "bestPractices": 0.20,
      "performance": 0.20,
      "clarity": 0.15
    },
    "performanceNotes": "RANKX is often more efficient than EARLIER+COUNTROWS for ranking operations"
  },
  "hints": [
    "EARLIER references the value from an outer row context",
    "Count how many products in the same category have a higher price",
    "Add 1 to convert from count-of-higher to rank"
  ],
  "tags": ["calculated-column", "earlier", "filter", "ranking", "context-transition", "advanced", "contoso"]
}
