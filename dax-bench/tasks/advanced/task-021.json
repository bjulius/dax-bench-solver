{
  "id": "task-021",
  "version": "1.0",
  "title": "Filter Intersection with KEEPFILTERS",
  "description": "Use KEEPFILTERS to intersect filters rather than replace them.",
  "complexity": "advanced",
  "category": "filtering",
  "prompt": {
    "system": "You are a DAX expert. Generate only the DAX code without any explanation or markdown formatting. Return the measure definition starting with the name followed by an equals sign.",
    "user": "Create a measure called 'Selected Category Audio Only' that calculates total Net Price for Audio products, but ONLY if Audio is already selected in the current filter context. If a different category is selected (e.g., Computers), the measure should return BLANK because there's no intersection. Use KEEPFILTERS to achieve filter intersection behavior.",
    "dataModelContext": "You are working with a sales database. Sales contains: Net Price (decimal). Product contains: Category (text - e.g., Audio, Computers, TV and Video). Relationship: Product[ProductKey] 1â†’M Sales[ProductKey]."
  },
  "expectedOutput": {
    "dax": "Selected Category Audio Only = CALCULATE(SUM(Sales[Net Price]), KEEPFILTERS(Product[Category] = \"Audio\"))",
    "alternativeCorrect": [
      "Selected Category Audio Only = IF(SELECTEDVALUE(Product[Category]) = \"Audio\", CALCULATE(SUM(Sales[Net Price]), Product[Category] = \"Audio\"), BLANK())",
      "Selected Category Audio Only = CALCULATE(SUM(Sales[Net Price]), KEEPFILTERS(FILTER(ALL(Product[Category]), Product[Category] = \"Audio\")))"
    ],
    "expectedResult": {
      "columns": ["Category", "Selected Category Audio Only"],
      "rows": [
        {"Category": "Audio", "Selected Category Audio Only": 13647440.58},
        {"Category": "Computers", "Selected Category Audio Only": null}
      ]
    }
  },
  "evaluationCriteria": {
    "syntaxWeight": 0.3,
    "outputMatchWeight": 0.7,
    "requiredElements": ["KEEPFILTERS", "CALCULATE"],
    "partialCreditRules": [
      { "condition": "contains_KEEPFILTERS", "credit": 0.5 },
      { "condition": "contains_CALCULATE", "credit": 0.3 }
    ],
    "bestPractices": {
      "required": ["KEEPFILTERS"],
      "preferred": [],
      "antiPatterns": []
    },
    "dimensionWeights": {
      "correctness": 0.45,
      "bestPractices": 0.20,
      "performance": 0.20,
      "clarity": 0.15
    },
    "performanceNotes": "KEEPFILTERS creates filter intersection which is efficient in the storage engine"
  },
  "hints": [
    "Without KEEPFILTERS, a filter in CALCULATE replaces the existing filter on the same column",
    "KEEPFILTERS causes the new filter to intersect with existing filters",
    "When filters don't intersect, the result is BLANK"
  ],
  "tags": ["measure", "keepfilters", "filter-intersection", "filtering", "advanced", "contoso"]
}
